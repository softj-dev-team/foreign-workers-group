<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="fragments/layout">

<th:block layout:fragment="layout-content">
    <div class="wrap2">
        <div class="header white">
            <div class="hd-in">
                <span class="title">FOR FOREIGN WORKERS!</span>
            </div>
        </div>
        <div class="board-wrap clearfix">
            <div class="social-login-wrap">

<!--                <fb:login-button -->
<!--                        scope="public_profile,email"-->
<!--                        onlogin="checkLoginState();">-->
<!--                </fb:login-button>-->

                <button type="button" class="facebookbtn" id="facebook"><i class="fb-i"></i>Log In With Facebook</button>
                <button type="button" class="googlebtn" id="google"><i class="gg-i"></i>Log In With Google</button>
                <button type="button" class="applebtn"><i class="ap-i"></i>Log In With  Apple</button>
            </div>
            <div class="orbox">
                <div class="or">OR</div>
            </div>
            <div class="anonymous-wrap">
<!--                <input type="file" id="image" accept="image/*" onchange="setThumbnail(event);"/> <div id="profilewrap" onclick="profileupload();">-->
                <input type="file" id="image" accept="image/*" onchange="setThumbnail(event);"/> <div id="profilewrap">
                    <div></div>
                </div>
                <input type="text" id="nickname" name="nickname" placeholder="Nickname">
                <button type="button" class="btn" onclick="anonymousLogin()">Anonymous login</button>
            </div>
        </div>
    </div>

    <script>
        /* 0. variable */

        /* 1. on load */
        $(function(){
            /* 2.init*/
            init();

            /* 3. event listener*/
            $("#facebook").click(function(){ //페이스북 버튼을 클릭하면
                    facebookLogin();

                    //1.클릭이벤트->2. 로그인하는거
            });

        })

        /* 4. function */
        function setThumbnail(event) {
            var reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById("profilewrap").innerHTML ="";
                var img = document.createElement("div");
                img.setAttribute("style", "background-image:url("+event.target.result+")");
                img.setAttribute("ID", "profileimg");
                document.querySelector("div#profilewrap").appendChild(img);
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        function profileupload(){
            var ele=document.getElementById('image');
            ele.click();
            console.log('test');
        }

        function anonymousLogin(){
            var nickname=$("[name=nickname]").val();
            if(ut.isEmpty(nickname)){
                modal.required("nickname");
                return;
            }
            $.post('/api/login',{nickname: nickname},function(res){
                ut.redirect("/");
            });//밑에 ajax랑 똑같이 사용해 주면 된다.

            /*$.ajax({
                type : "POST",            // HTTP method type(GET, POST) 형식이다.
                url : '/api/anonymousLogin',      // 컨트롤러에서 대기중인 URL 주소이다.
                data : {nickname: nickname},            // Json 형식의 데이터이다.
                success : function(res){
                    ut.redirect("/");
                }
            });*/
        }
    </script>

    <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '961134184788407',
                cookie     : true,
                xfbml      : true,
                version    : 'v12.0'
            });

            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);

            });
            //FB.AppEvents.logPageView();
        };

        //로그인 상태에 따라 로그인 /
        // const statusChangeCallback = (res)=>{
        //     if(res.status === 'connected')
        //         alert("로그인성공");
        //
        //
        // }

        //페이스북 (로그인)
        const facebookLogin = ()=>{
            //로그인 정보 GET
            FB.login((res)=>{
                //사용자 정보 GET
                FB.api(//페이스북api
                    `/${res.authResponse.userID}/`,//결과값이res2에 담김
                    'GET',
                    {"fields":"id,name,email"},//id,name,email,사진등등..
                    (res2) => {
                        //res.authResponse.accessToken : 엑세스 토큰
                        //res.authResponse.graphDomain : 공급자 (페이스북)
                        //res.authResponse.userID : 유저 아이디 구분 (숫자)
                        //res2.name : 유저 이름
                        //res2.email : 유저 이메일 정보
                        //document.querySelector('#logBtn').value="로그아웃";
                        console.log(res,res2);
                        $.post('/api/login',{id: res2.id,platform:"facebook"},function(res){
                            ut.redirect("nickName");
                        });//밑에 ajax랑 똑같이 사용해 주면 된다.
                    });
            });

        }



        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));


        // FB.getLoginStatus(function(response) {
        //     statusChangeCallback(response);
        // }); //로그인 상태확인.


    </script>
    <script>
        //처음 실행하는 함수
        function init() {
            gapi.load('auth2', function() {
                gapi.auth2.init();
                options = new gapi.auth2.SigninOptionsBuilder();
                options.setPrompt('select_account');
                // 추가는 Oauth 승인 권한 추가 후 띄어쓰기 기준으로 추가
                options.setScope('email profile openid https://www.googleapis.com/auth/user.birthday.read');
                // 인스턴스의 함수 호출 - element에 로그인 기능 추가
                // GgCustomLogin은 li태그안에 있는 ID, 위에 설정한 options와 아래 성공,실패시 실행하는 함수들
                gapi.auth2.getAuthInstance().attachClickHandler('google', options, onSignIn, onSignInFailure);
            })
        }
        function onSignIn(googleUser) {
            $.post('/api/login',{id: googleUser.yu.nv,platform:"google"},function(res){
                ut.redirect("nickName");
            });

            // var access_token = googleUser.getAuthResponse().access_token
            // $.ajax({
            //     // people api를 이용하여 프로필 및 생년월일에 대한 선택동의후 가져온다.
            //     url: 'https://people.googleapis.com/v1/people/me'
            //     // key에 자신의 API 키를 넣습니다.
            //     , data: {personFields:'birthdays', key:'AIzaSyDpiDBcW6vMNRnnyKLQUzzH-MocouQOn14', 'access_token': access_token}
            //     , method:'POST'
            // }).done(function(e){
            //         //프로필을 가져온다.
            //         var profile = googleUser.getBasicProfile();
            //         console.log(profile)
            //         $.post('/api/login',{id: res2.id,platform:"google"},function(res){
            //             ut.redirect("nickName");
            //         });//밑에 ajax랑 똑같이 사용해 주면 된다.
            // }).fail(function(e){
            //     console.log(e);
            //})

        }

        function onSignInFailure(t){
            console.log(t);
        }
    </script>



</th:block>